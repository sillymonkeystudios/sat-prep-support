<!-- public/invite.html -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Join Leaderboard on SatUP!</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        background: #fcf7e9;
        color: #333;
      }
      .container {
        background: white;
        color: #333;
        border-radius: 20px;
        padding: 40px;
        max-width: 400px;
        width: 100%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        text-align: center;
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 24px;
      }
      .inviter {
        color: #666;
        margin-bottom: 30px;
      }
      .buttons {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .button {
        padding: 14px 24px;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        transition: transform 0.2s;
      }
      .button:active {
        transform: scale(0.98);
      }
      .button-primary {
        background: #667eea;
        color: white;
      }
      .button-secondary {
        background: #f0f0f0;
        color: #333;
      }
      .logo {
        width: 80px;
        height: 80px;
        margin: 0 auto 20px;
        border-radius: 20px;
        object-fit: contain;
      }
      .desktop-message {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        color: #666;
        font-size: 14px;
        line-height: 1.5;
      }
      .desktop-message strong {
        color: #333;
        display: block;
        margin-bottom: 8px;
      }
      .qr-code {
        width: 200px;
        height: 200px;
        margin: 15px auto;
        border: 4px solid #f0f0f0;
        border-radius: 10px;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .qr-code img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      .desktop-only {
        display: none;
      }
      .mobile-only {
        display: block;
      }
      @media (min-width: 768px) {
        .desktop-only {
          display: block !important;
        }
        .mobile-only {
          display: none !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <img src="icon.png" alt="SatUP Logo" class="logo" />
      <h1 id="leaderboard-name">Loading...</h1>
      <p class="inviter" id="inviter-text"></p>

      <div class="desktop-only">
        <div class="desktop-message">
          <strong>ðŸ“± Open this link on your iPhone</strong>
          Scan the QR code below with your iPhone camera to open this invite in
          the SatUP! app, or copy the link and open it on your iOS device.
        </div>
        <div class="qr-code" id="qr-code">
          <img id="qr-image" src="" alt="QR Code" />
        </div>
      </div>

      <div class="buttons">
        <a
          href="#"
          id="open-app-button"
          class="button button-primary mobile-only"
        >
          Open in SatUP! App
        </a>
        <a href="#" id="app-store-button" class="button button-secondary">
          <span class="mobile-only">Download App</span>
          <span class="desktop-only">View on App Store</span>
        </a>
        <a
          href="#"
          id="copy-link-button"
          class="button button-secondary desktop-only"
        >
          Copy Invite Link
        </a>
      </div>
    </div>

    <script>
      // Supabase configuration
      const SUPABASE_URL = "https://hixwqdbhxnwhgbqeqpcu.supabase.co";
      const SUPABASE_ANON_KEY =
        "sb_publishable_PT13A5qk3rJJyxjpkoxL5g_5dWZSTcL";

      // Parse token from URL
      const params = new URLSearchParams(window.location.search);
      const token = params.get("token");

      // Deep link (set early for QR code generation)
      const deepLink = token ? `satup://invite?token=${token}` : "";

      if (!token) {
        document.getElementById("leaderboard-name").textContent =
          "Invalid invite link";
        document.getElementById("inviter-text").textContent =
          "This invite link is missing the token.";
        document.getElementById("open-app-button").style.display = "none";
      } else {
        // Fetch token info from database
        fetch(`${SUPABASE_URL}/rest/v1/rpc/get_invite_token_info`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            apikey: SUPABASE_ANON_KEY,
          },
          body: JSON.stringify({ p_token: token }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data && data.length > 0 && data[0].is_valid) {
              const info = data[0];
              document.getElementById(
                "leaderboard-name"
              ).textContent = `Join "${info.leaderboard_name}"`;
              document.getElementById(
                "inviter-text"
              ).textContent = `${info.inviter_username} invited you to join this leaderboard.`;

              // Set deep link
              document.getElementById("open-app-button").href = deepLink;
            } else {
              document.getElementById("leaderboard-name").textContent =
                "Invalid or expired invite link";
              document.getElementById("inviter-text").textContent =
                "This invite link is invalid or has expired.";
              document.getElementById("open-app-button").style.display = "none";
            }
          })
          .catch((error) => {
            console.error("Error fetching invite info:", error);
            document.getElementById("leaderboard-name").textContent =
              "Error loading invite";
            document.getElementById("inviter-text").textContent =
              "Unable to load invite information.";
            document.getElementById("open-app-button").style.display = "none";
          });
      }

      // Set deep link for button (even if token is missing, for QR code)
      document.getElementById("open-app-button").href = deepLink;

      // Detect device type
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isMobile =
        /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
          navigator.userAgent
        );
      const isDesktop = !isMobile;

      // App Store link
      const appStoreUrl = "https://apps.apple.com/us/app/satup/id6757409537";
      document.getElementById("app-store-button").href = appStoreUrl;

      // Desktop-specific features
      if (isDesktop) {
        // Generate QR code for the current invite URL
        const currentUrl = window.location.href;
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(
          currentUrl
        )}`;
        document.getElementById("qr-image").src = qrCodeUrl;

        // Copy link functionality
        document
          .getElementById("copy-link-button")
          .addEventListener("click", (e) => {
            e.preventDefault();
            navigator.clipboard
              .writeText(currentUrl)
              .then(() => {
                const button = e.target;
                const originalText = button.textContent;
                button.textContent = "âœ“ Link Copied!";
                setTimeout(() => {
                  button.textContent = originalText;
                }, 2000);
              })
              .catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement("textarea");
                textArea.value = currentUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
                const button = e.target;
                const originalText = button.textContent;
                button.textContent = "âœ“ Link Copied!";
                setTimeout(() => {
                  button.textContent = originalText;
                }, 2000);
              });
          });
      }

      // Mobile behavior: try to open app automatically (iOS only)
      if (isIOS) {
        setTimeout(() => {
          window.location.href = deepLink;
          // If app doesn't open, fallback to app store after 1 more second
          setTimeout(() => {
            if (document.hasFocus()) {
              // App didn't open, redirect to app store
              window.location.href = appStoreUrl;
            }
          }, 1000);
        }, 2000);
      }
    </script>
  </body>
</html>
